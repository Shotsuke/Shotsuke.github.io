---
title: æ“ä½œç³»ç»Ÿå®éªŒéƒ¨åˆ† <Operating System Experiments>
date: 2024-03-24 16:43:16
categories: "Course Notes"
tags: Note
---

# M1: pstree

ä»»åŠ¡ï¼šå®ç°ç±»ä¼¼äºlinuxä¸­çš„`pstree`å‘½ä»¤ï¼ŒåŒ…å« `-p -n -V`å‚æ•°ã€‚

æ”¶è·ï¼šç†è§£pidï¼Œçº¿ç¨‹ï¼Œè¿›ç¨‹ï¼ŒæŸ¥çœ‹è¿›ç¨‹å·ï¼Œæ ¼å¼åŒ–æ‰“å°å‰ç¼€ã€‚

_**éš¾åº¦ï¼šğŸ˜¼MEDIUM**_ _**è€—æ—¶ï¼šâŒ›6 h**_

æ ¸å¿ƒæ€æƒ³ï¼š
```
/proc/[pid]/stat
/proc/[pid]/status
```
åŒ…å«äº†pidçš„å…³é”®ä¿¡æ¯ã€‚
è¿­ä»£åœ°ç»´æŠ¤ä»¥{' ' , '|'}ç»„æˆçš„å‰ç¼€æ¥æ‰“å°å³èƒ½å¤Ÿæ‰“å°æ¼‚äº®çš„ç¼©è¿›ï¼Œè§£å†³äº†è¿™ä¸ªä¹‹åæ‰“å°`pstree`ä¾¿æ˜“å¦‚åæŒã€‚

# M2: libco

**âœŠâœŠâœŠ**

![Step by step to finish it.](\../imgs/Operating-System-Experiments/M2-AC.jpg)

ä»»åŠ¡ï¼šè‡ªå®šä¹‰ç»“æ„ä½“ï¼Œå®Œæˆåç¨‹åº“

æ”¶è·ï¼šç†è§£çº¿ç¨‹/åç¨‹çš„å·¥ä½œåŸç†ã€‚

_**éš¾åº¦ï¼šğŸ™€WARNING**_ _**è€—æ—¶ï¼šâŒ›MANY h**_

é¦–å…ˆï¼Œä»¥Cè¯­è¨€å®ç°åç¨‹åº“æœ‰è‹¥å¹²ç§æ–¹æ³•ï¼š
- æˆ‘æ˜¯æ±‡ç¼–å¤§ç¥ï¼`asm volatile`
- å®éªŒæ‰‹å†Œå°±æ˜¯æˆ‘çˆ¹ï¼`setjmp / longjmp`
- æ¨å€’å®éªŒæ‰‹å†Œï¼Œæ„å»ºè‡ªå·±çš„åç¨‹ç»“æ„ï¼`ucontext`
- è¿˜ç©ä¸ç©ğŸ˜“ä¹‹æœ¬æœ«å€’ç½®ï¼`Pthread`

æˆ‘å†™äº†ï¼š
- `setjmp / longjmp`: OJ AC!ï¼Œä½†æ˜¯äº4/8/24æƒ¨é­åŒå­¦hackğŸ˜­ï¼ˆè™½ç„¶jyyå¹¶æ²¡æœ‰å¢å¼ºæµ‹è¯•æ•°æ®ï¼‰
- `ucontext`ï¼šOJ AC!ï¼Œåœ¨hackä¹‹ä¸­å­˜æ´»=v=

æ•´åˆæ‰€æœ‰wikiä¸Šçš„ä»£ç ï¼Œèƒ½å¤Ÿå¾—åˆ°è¿™æ ·çš„ä¸€ä»½æ¡†æ¶ï¼Œå¯¹äºåç¨‹çš„å®ç°éƒ½æœ‰å¸®åŠ©ï¼š
```C
#include "co.h"
#include <stdio.h>

#include <stdint.h>
#include <setjmp.h>

#define DEBUG

enum co_status {
    CO_NEW = 1, // æ–°åˆ›å»ºï¼Œè¿˜æœªæ‰§è¡Œè¿‡
    CO_RUNNING, // å·²ç»æ‰§è¡Œè¿‡
    CO_WAITING, // åœ¨ co_wait ä¸Šç­‰å¾…
    CO_DEAD,    // å·²ç»ç»“æŸï¼Œä½†è¿˜æœªé‡Šæ”¾èµ„æº
};

struct co {
    char *name;
    void (*func)(void *); // co_start æŒ‡å®šçš„å…¥å£åœ°å€å’Œå‚æ•°
    void *arg;

    enum co_status status;              // åç¨‹çš„çŠ¶æ€
    struct co *    waiter;              // æ˜¯å¦æœ‰å…¶ä»–åç¨‹åœ¨ç­‰å¾…å½“å‰åç¨‹
    struct context context;             // å¯„å­˜å™¨ç°åœº
    uint8_t        stack[STACK_SIZE];   // åç¨‹çš„å †æ ˆ
};

struct co* current;

// __attribute__((constructor)) void init() {}

struct co *co_start(const char *name, void (*func)(void *), void *arg)
{
}

void       co_wait(struct co *co)
{
}

void       co_yield()
{
    int val = setjmp(current->context);
    if (val == 0) {
        // ?
    } else {
        // ?
    }
}

// static inline void
// stack_switch_call(void *sp, void *entry, uintptr_t arg) {
//     asm volatile (
// #if __x86_64__
//         "movq %0, %%rsp; movq %2, %%rdi; jmp *%1"
//           :
//           : "b"((uintptr_t)sp),
//             "d"(entry),
//             "a"(arg)
//           : "memory"
// #else
//         "movl %0, %%esp; movl %2, 4(%0); jmp *%1"
//           :
//           : "b"((uintptr_t)sp - 8),
//             "d"(entry),
//             "a"(arg)
//           : "memory"
// #endif
//     );
// }
```

## setjmp / longjmp æ–¹å¼
```pseudocode
struct co *co_start(const char *name, void (*func)(void *), void *arg)
{
    Initialize coroutine
    Record cotoutine to coroutine list
}
void       co_wait(struct co *co)
{
    do co_yield until co is CO_DEAD
    free(co)
    // hacked
}
void       co_yield()
{
    int val = setjmp(current->context);
    if (val == 0) 
    {
        random choose co to be next.
        if co is CO_NEW:
            turn it to CO_RUNNING
            save context and change to function of co

            recover context
            turn it to CO_DEAD
            if someone else is watting co do:
                turn to that coroutine
            co_yield()
            // hacked
        else
            turn to the current coroutine
    } 
    else 
    {
        Actually we do nothing here,
        because only longjmp( , 1) can reach here.
        In this case we let coroutine do its own.
    }
}
```

Hackè§¦å‘æ¡ä»¶:
- callerè¦æ¯”calleeå…ˆæ­»
- calleréœ€è¦æ˜¯waitå¯åŠ¨çš„ï¼Œä¸”åœ¨calleeè¿”å›å‰è¢«å›æ”¶

åœ¨æˆ‘çš„ä»£ç ä¸­ï¼Œ`wait`é‡Œè°ƒç”¨`free`ï¼Œä½†æ˜¯åœ¨`yield`ä¸­è®¾ç½®DEADï¼Œæ®è¯´å°±ä¼šè§¦å‘bugã€‚è§¦å‘bugæ—¶ä¼šè¿”å›åˆ°ä¸€ä¸ªå·²ç»è¢«å›æ”¶çš„æ ˆçš„rspï¼Œç„¶åğŸ’€ã€‚
~~hack~~è°ƒè¯•ä»£ç å¦‚ä¸‹ï¼š
```C
typedef struct m_pair
{
    int i;
    int j;
} m_pair;

static void f(void *ptr_in)
{
    struct m_pair *ptr = (struct m_pair *)ptr_in;
    printf("round:%d coroutine:%d\n", (*ptr).i, (*ptr).j);
    co_yield ();
}

static void test_3()
{
    for (size_t i = 0; i < 1000; i++)
    {
        struct co *thd[100];
        m_pair *p[100];
        for (size_t k = 0; k < 100; k++)
        {
            p[k] = NULL;
            thd[k] = NULL;
        }
        for (size_t j = 0; j < 5; j++)
        {
            p[j] = (m_pair *)malloc(sizeof(m_pair));
            p[j]->i = i;
            p[j]->j = j;
            thd[j] = co_start("Test", f, p[j]);
        }
        for (size_t j = 0; j < 5; j++)
        {
            co_wait(thd[j]);
        }
        for (size_t j = 0; j < 5; j++)
        {
            free(p[j]);
        }
    }
    printf("Test 3 success\n");
}
```

## ucontext æ–¹å¼
å»CSDNä¸Šæœä¸€ç¯‡æ¥è¯»äº†ï¼Œä¸€å¤©å°±èƒ½å†™å®Œã€‚
åŸºæœ¬æ€è·¯ä¸ä¸Šè¿°ç±»ä¼¼ï¼Œä½†æ˜¯ç»™å‡ºçš„åº“å‡½æ•°èƒ½å¤Ÿå¸®åŠ©æ‘†è„±ä¸€å¤§å †å†—é•¿çš„æ±‡ç¼–ä»£ç ï¼Œä½¿ä»£ç æ€»ä½“å˜å¾—ååˆ†ç®€æ´ã€‚
å±äºæ˜¯è€å¥¶å¥¶åè½®æ¤…ç¢¾è¿‡OJäº†ã€‚ğŸ‘µâ™¿â™¿â™¿

# M3: gpt.c

ä»»åŠ¡ï¼šä»æŒ‡å®šçš„ç¨‹åºä¸­æ‰¾åˆ°èƒ½å¤Ÿä½¿ç”¨å¹¶è¡Œå¤§å¹…æå‡è¿è¡Œé€Ÿåº¦çš„ä»£ç æ®µï¼Œå¹¶å¹¶è¡ŒåŒ–å¤„ç†ã€‚

æ”¶è·ï¼šå¹¶è¡Œä¼˜åŒ–ã€‚

_**éš¾åº¦ï¼šğŸ˜ºEASY**_ _**è€—æ—¶ï¼šâŒ›2 h**_

æ ¸å¿ƒæ€æƒ³ï¼šä¸€ä¸ªå¯æ‰§è¡Œç¨‹åºï¼Œæ‰§è¡Œéƒ¨åˆ†æ€»æ˜¯è‹¥å¹²ä¸ªå‡½æ•°ã€‚å¦‚æœæœ‰ä¸ªå‘½ä»¤èƒ½å¤Ÿæ‰¾å‡ºå‡½æ•°ä¸­è€—æ—¶æœ€é«˜çš„é‚£ä¸ªå°±å¥½äº†ï¼

`sudo perf top`èƒ½å¤Ÿå®æ—¶æŸ¥è¯¢è®¡ç®—æœºä¸­å ç”¨æ€§èƒ½è‹¥å¹²topä½çš„ç¨‹åºã€‚å…¶ä¸ä»…èƒ½å¤Ÿæä¾›ç¨‹åºåï¼Œè¿˜èƒ½å¤Ÿæ·±å…¥åœ°æŸ¥è¯¢åˆ°æ¯ä¸ªç¨‹åºä¸­è‹¥å¹²è€—æ—¶æœ€é«˜å‡½æ•°çš„åç§°ã€‚

å¦ä¸€æ–¹é¢å°±æ˜¯æ€è€ƒé‚£äº›ä»£ç å—èƒ½å¤Ÿå¹¶è¡ŒåŒ–ã€‚åœ¨æœ€å¤§å¯èƒ½é¿å…æ•°æ®ç«äº‰çš„æƒ…å†µä¸‹è¿›è¡Œå¹¶è¡ŒåŒ–å¤„ç†ï¼Œå¦åˆ™åœ¨å‘ç”Ÿæ•°æ®ç«äº‰çš„æƒ…å†µä¸‹ï¼Œå®é™…ä¸Šå¹¶ä¸èƒ½å¾—åˆ°**ç›¸æ¯”äºä¸²è¡Œç¨‹åºï¼Œåœ¨ä¸€ä¸ªkä¸ªå¤„ç†å™¨çš„è®¡ç®—æœºä¸Šï¼Œé™¤å»æ¨¡å‹åŠ è½½æ—¶é—´ï¼Œä½ åº”å½“åœ¨æœ‰è¾ƒå¤šè½®æ¨ç†æ—¶å¾—åˆ°è¿‘ä¼¼çº¿æ€§ (kå€) çš„åŠ é€Ÿæ¯”ã€‚**

å› ä¸ºæ•°æ®ç«äº‰ä¼šå¯¼è‡´é”ï¼Œè€Œé”ä¼šä½¿å¾—æŸä¸ªå˜é‡çš„è®¿é—®ä¸å¯å¹¶è¡ŒåŒ–ã€‚

# M4: crepl

**ä½ æ€ä¹ˆçŸ¥é“æˆ‘ä¸€å‘ç§’äº†ğŸ¤£ğŸ¤£ğŸ¤£**

![ONE submit kills the match.](\../imgs/Operating-System-Experiments/M4-AC.jpg)

ä»»åŠ¡ï¼šCè¯­è¨€åŒæ ·ä¹Ÿå¯ä»¥å®ç°â€œäº¤äº’å¼â€çš„shellï¼Œæ”¯æŒå³æ—¶å®šä¹‰å‡½æ•°ï¼Œè€Œä¸”èƒ½è®¡ç®—Cè¡¨è¾¾å¼çš„æ•°å€¼ã€‚

æ”¶è·ï¼š`/tmp`ç›®å½•æ“ä½œï¼Œæ–‡ä»¶æ“ä½œï¼Œå…±äº«åº“çš„ç¼–è¯‘ç”Ÿæˆå’Œé“¾æ¥ç¼–è¯‘ï¼Œå¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œ`exec`å‡½æ•°æ—çš„ä½¿ç”¨ã€‚

_**éš¾åº¦ï¼šğŸ˜¹HARD**_ _**è€—æ—¶ï¼šâŒ›12 h**_

åœ¨å¤§ä¸€æ—¶ï¼Œæˆ‘å†™è¿‡ä¸€ä¸ª[**ç®€å•è¯­è¨€çš„è§£é‡Šå™¨**](https://github.com/Shotsuke/SimpleLexerAnalyzer)ï¼Œæˆ‘è§‰å¾—å…ˆæœ‰äº†è¿™ä¸ªèƒ½å¤Ÿå¯¹å®éªŒæœ‰é‚£ä¹ˆä¸€ä¸ç‚¹çš„å¯å‘å§ã€‚

æ¥å—ç”¨æˆ·çš„äº¤äº’è¾“å…¥å‡½æ•°ï¼Œå°†å…¶æ‹¼æ¥åˆ°`.c`æ–‡ä»¶ä¸­ï¼Œç¼–è¯‘ç”Ÿæˆå…±äº«åº“`.so`ï¼›æ¥å—ç”¨æˆ·çš„äº¤äº’è¾“å…¥è¡¨è¾¾å¼ï¼Œå°†å…¶æ‹¼æ¥åˆ°å¦ä¸€ä¸ª`.c`æ–‡ä»¶ä¸­ï¼Œå’Œå…±äº«åº“é“¾æ¥ç¼–è¯‘å¾—åˆ°ç»“æœã€‚æ•´ä¸ªå®éªŒçš„æµç¨‹éå¸¸æ¸…æ™°ï¼Œä½†æ˜¯å®ç°éå¸¸çš„æ³¨é‡ç»†èŠ‚ï¼ˆè¿™åŒæ ·æ˜¯è§£é‡Šå™¨éå¸¸å¤´ç–¼çš„ç‚¹ï¼Œè™½ç„¶è¯´å…³æ³¨çš„ç»†èŠ‚å‡ ä¹å®Œå…¨ä¸ä¸€æ ·ï¼‰ï¼š
- `/tmp`æ–‡ä»¶å¤¹ä¸‹çš„æ–‡ä»¶å¤„ç†
- `exec`å‡½æ•°æ—çš„å‚æ•°ä¼ å…¥
- `fork`çš„çˆ¶å­è¿›ç¨‹çš„å…³ç³»ã€ç­‰å¾…
- å¯¹ä¸é€šè¿‡ç¼–è¯‘çš„é”™è¯¯è¯­æ³•è¾“å…¥çš„å¤„ç†

# M5: sperf

**ä¸»æ’­ç»™æ‰“æ€¥çœ¼äº†ï¼Œé‚å‡ ä¹é€šå®µå¹²è¿™ä¸ªå®éªŒğŸ˜¡ğŸ˜¡ğŸ˜¡**

![Stay up to work out it QAQ](\../imgs/Operating-System-Experiments/M5-AC.jpg)

ä»»åŠ¡ï¼šå®ç°ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œå®ƒèƒ½å¯åŠ¨å¦ä¸€ä¸ªç¨‹åºï¼Œå¹¶ç»Ÿè®¡è¯¥ç¨‹åºä¸­å„ä¸ªç³»ç»Ÿè°ƒç”¨çš„å ç”¨æ—¶é—´ã€‚

æ”¶è·ï¼šæ–‡ä»¶æ“ä½œï¼Œå‘½ä»¤`strace`ï¼Œ`exec`å‡½æ•°æ—åŸç†ï¼Œç®¡é“è¯»å†™/æ–‡ä»¶è¯»å†™ã€‚

_**éš¾åº¦ï¼šğŸ˜¹HARD**_ _**è€—æ—¶ï¼šâŒ›12 h**_

DDLæˆ˜å£«å°±æ˜¯è¦M4ï¼ŒM5è¿ç€ä¸€èµ·å†™ï¼äºŒè€…çš„æ–‡ä»¶æ“ä½œã€å­çº¿ç¨‹çš„åˆ›å»ºæ€è·¯éå¸¸çš„ç›¸ä¼¼ã€‚

ä½¿ç”¨`strace -T [COMMAND] [ARGV]`æ¥å¾—åˆ°ç¨‹åºå„ç³»ç»Ÿè°ƒç”¨çš„è¿è¡Œæ—¶é—´ï¼Œè§£æå…¶è¾“å‡ºæ¥æ’åºã€‚è¿™æ˜¯è¿™ä¸ªå®éªŒçš„ä¸»è°ƒã€‚

ä½†æ˜¯å¦å¤–ï¼Œæœ¬å®éªŒéå¸¸è€ƒå¯Ÿå„ç§è¾“å‡ºæ–¹å¼ã€‚
- std
  - stdout
  - stderr
- redirection
  - fprintf -> FILE
  - pipe
    - dup2
    - -o
    - >

å¦‚ä½•å°†`strace`çš„è¾“å‡ºå’Œ`COMMAND`çš„è¾“å‡ºåŒºåˆ†å¼€ï¼Œå¥½å§å…¶å®æ–¹æ³•æœ‰å¾ˆå¤š:)

# M6: fsrecov

**è€»è¾±ä¸‹æ’­ğŸ˜µ**

![M6-part-correct](\../imgs/Operating-System-Experiments/M6-part.jpg)

ä»»åŠ¡ï¼šç»™å‡ºä¸€ä¸ªè¢«å¿«é€Ÿæ ¼å¼åŒ–çš„FAT32ç»“æ„çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå°½å¯èƒ½åœ°è¿˜åŸå‡ºå…¶ä¸­çš„æ•°æ®ã€‚

æ”¶è·ï¼šç†è§£FAT32æ–‡ä»¶ç³»ç»Ÿï¼Œæ‰‹å†Œé˜…è¯»èƒ½åŠ›ï¼Œé•¿ç¯‡ä»£ç ç¼–å†™ã€‚

æ²¡å†™ï¼šå¯¹æ•°æ®å­˜æ”¾åœ¨ä¸è¿ç»­ç°‡ä¸­çš„å›¾ç‰‡æ¢å¤ï¼ˆå·ç§¯ã€ç¥ç»ç½‘ç»œç­‰ï¼‰

_**éš¾åº¦ï¼šğŸ™€WARNING**_ _**è€—æ—¶ï¼šâŒ›24hï¼ˆæ²¡æ‰“è¿‡ï¼‰**_

æ·±è¯»äº†ï¼š[JYY os persistance readfat.c](https://jyywiki.cn/os-demos/persistence/readfat/) (or: `wget -r -np -nH --cut-dirs=2 -R "index.html*"`)

å› æ­¤å…ˆä»¥readfat.cæºä»£ç æ¥ç†è§£FAT32æ–‡ä»¶ç³»ç»Ÿã€‚å…¶å®åœ¨ä»£ç ä¸­å¹¶æ²¡æœ‰éšè—ä»€ä¹ˆé«˜æ·±çš„ç»“æ„ï¼Œæ¯•ç«ŸFAT32æ–‡ä»¶ç³»ç»Ÿæœ¬èº«ä¹Ÿä¸æ˜¯ç‰¹åˆ«çš„å¤æ‚ã€‚FAT32æ–‡ä»¶ç»“æ„åŠå…¶éå†æ€è·¯å¦‚å›¾ã€‚
- å…³é”®å¤´æ–‡ä»¶`fat32.h`
  - `fat32hdr` è®°å½•äº†ä¿ç•™æ‰‡åŒºçš„å†…å®¹ï¼ˆå‰512å­—èŠ‚ï¼‰
  - `fat32dent` è®°å½•äº†æ•°æ®åŒºçš„å†…å®¹
  - `__attribute__((packed))` ç¦ç”¨å¯¹é½
- å…¨å±€å˜é‡
  - `struct fat32hdr *hdr` ç”¨äºå­˜å‚¨ FAT32 æ–‡ä»¶ç³»ç»Ÿçš„å¤´éƒ¨ä¿¡æ¯ã€‚
- å‡½æ•°
  - `void *mmap_disk(const char *fname)` å°†ç»™å®šçš„.imgé•œåƒæ–‡ä»¶æ˜ å°„åˆ°å†…å­˜ä¸­
  - `u32 next_cluster(int n)`  è¿”å›ä¸‹ä¸€ä¸ªç°‡çš„å€¼
  - `void *cluster_to_sec(int n)` å°†ç°‡å·è½¬åŒ–ä¸ºåœ°å€
  - `void dfs_scan(u32 clusId, int depth, int is_dir)` éå†æœç´¢

![FAT32](\../imgs/Operating-System-Experiments/FAT32.jpg)

åœ¨ç†è§£äº†FAT32æ–‡ä»¶ç³»ç»Ÿä¹‹åï¼ŒæŸ¥çœ‹å…¶å¯¹äºå¿«é€Ÿæ ¼å¼åŒ–çš„è¯´æ˜ã€‚å…¶å¿«é€Ÿæ ¼å¼åŒ–æ¸…ç©ºäº†æ•´ä¸ªfatè¡¨ï¼Œå’Œæ ¹ç›®å½•æ–‡ä»¶å¤¹(`./`)å¯¹åº”çš„ç°‡ä¸‹æ‰€æœ‰çš„ä¿¡æ¯ã€‚å› æ­¤åªèƒ½ä»æ•°æ®åŒºå…¥æ‰‹ã€‚æ ¹æ®å®éªŒæè¿°ï¼Œæ ¹ç›®å½•æ–‡ä»¶å¤¹ä¸‹è¿˜æœ‰ä¸€ä¸ªæ–‡ä»¶å¤¹(`./DCIM/`)ï¼Œè¯¥æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰å†…å®¹ä»ç„¶åœ¨æ•°æ®åŒºä¸­ï¼Œå› æ­¤å¯ä»¥é€šè¿‡æš´åŠ›æŸ¥æ‰¾è¯¥æ–‡ä»¶å¤¹çš„æ‰€æœ‰ç°‡æ¥æ¢å¤å‡ºæ‰€æœ‰æ–‡ä»¶çš„æ–‡ä»¶åã€‚

`east test 1` å’Œ `easy test 2` å‡åªè¦æ±‚æ¢å¤å‡ºæ–‡ä»¶åã€‚çŒœæµ‹è¿™ä¸¤ä¸ªæµ‹è¯•ç‚¹åªæœ‰åˆ›å»ºæ–‡ä»¶ï¼Œæ²¡æœ‰åˆ é™¤æ–‡ä»¶ï¼Œè¿™æ„å‘³ç€ï¼Œè¿™ä¸¤ä¸ªæµ‹è¯•ç‚¹çš„`./DCIM/`æ‰€åœ¨ç°‡çš„ç°‡å·ä¸€å®šæ˜¯å‡åºè¿ç»­çš„ã€‚å°±æ˜¯è¯´ï¼Œå¦‚æœç°‡3ï¼Œ8215ï¼Œ15318ä¸‰ä¸ªç°‡æ˜¯åˆ†é…ç»™è¿™ä¸ªæ–‡ä»¶å¤¹çš„ï¼Œé‚£ä¹ˆè®¿é—®é¡ºåºä¸€å®šæ˜¯3ï¼Œ8215ï¼Œ15318ã€‚è€Œåœ¨`hard test`ä¸­æ–‡ä»¶å¤¹ç°‡å¹¶æ²¡æœ‰å‡åºè¿ç»­ï¼Œä¹Ÿå°±æ˜¯è¯´å®é™…ä¸Šçš„è®¿é—®é¡ºåºå¯èƒ½æ˜¯3ï¼Œ15318ï¼Œ8215ã€‚

å¯¹äº`hard test`ä¸‹çš„æ–‡ä»¶æ¢å¤ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š
- æ–‡ä»¶å¤¹ç°‡å·ä¸å‡åºè¿ç»­
  - å¦‚æœè®¤ä¸ºæ–‡ä»¶å¤¹ç°‡å·å‡åºè¿ç»­ï¼Œä»…èƒ½å¤„ç†çº¦1/3çš„æ•°æ®
- æ–‡ä»¶çš„ç°‡å·å€¾å‘è¿ç»­ï¼Œä½†ä»ç„¶ä¼šæ–­å¼€ä¸è¿ç»­ï¼Œä¾‹å¦‚#9135-#9318, #9462-#9499å­˜æ”¾äº†ä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®
  - å¦‚æœè®¤ä¸ºæ–‡ä»¶ç°‡å·å…¨éƒ¨è¿ç»­ï¼Œåˆ™å‡ ä¹æ²¡èƒ½æ¢å¤ä»»ä½•æ•°æ®
  - ä¸»æ’­æ²¡å¤„ç†å®Œè¿™ä¸€éƒ¨åˆ†qaqï¼Œå› ä¸ºè¿˜è¦æ‰“L1å’ŒL2:(

# L0: hello, bare-metal!

ä»»åŠ¡ï¼šåœ¨è£¸æœºä¸Šç¼–ç¨‹ï¼Œå®ç°**æ˜¾ç¤º**ä¸€å¼ å›¾ç‰‡å’Œç›‘æµ‹é”®ç›˜çš„è¾“å…¥ã€‚

_**éš¾åº¦ï¼šğŸ˜ºEASY**_ _**è€—æ—¶ï¼šâŒ›1 h**_

ä»”ç»†ç ”è¯»ç»™å‡ºçš„kernelä»£ç ï¼Œä»¥åŠå®éªŒè¦æ±‚ï¼Œå°±èƒ½åœ¨åè¡Œå†…å®Œæˆè¿™ä¸ªå®éªŒã€‚

**âš **ï¼šè°ƒç”¨`halt()`å’Œè°ƒç”¨`return`å°è¯•ä½¿ç¨‹åºç»“æŸä¼šäº§ç”Ÿä¸åŒçš„ç¨‹åºç»“æŸæƒ…å†µã€‚ä½¿ç”¨`halt()`å¯èƒ½å¯ä»¥ä½¿ä½ åœ¨ä½ çš„æœ¬åœ°ç¯å¢ƒä¸Šæ­£å¸¸åœ°é€€å‡ºç¨‹åºï¼Œä½†æ˜¯æ²¡æ³•é€šè¿‡OJï¼ŒæŠ¥é”™ä¿¡æ¯ä¸ºç¨‹åºæœªç»“æŸã€‚

# L1: pmm

`abstract-machine/am/src/native/mpe.c`ä¸­è®°å½•äº†CPUæ•°é‡ä»¥åŠè·å–CPUç¼–å·çš„æ–¹æ³•(ç¼–å·ä»é›¶å¼€å§‹è®¡æ•°)ï¼Œä»¥åŠè‡ªå¸¦äº†åŸå­äº¤æ¢ï¼š

```C++
int cpu_count() {
  extern int __am_ncpu;
  return __am_ncpu;
}

int cpu_current() {
  return thiscpu->cpuid;
}

int atomic_xchg(int *addr, int newval) {
  return atomic_exchange((int *)addr, newval);
}
```

**ä¸ºä»€ä¹ˆåˆšå¥½<span style="color:red; font-weight:700">å¯ä»¥ç›´æ¥æ‹’ç»è¶…è¿‡ 16 MiB çš„å†…å­˜åˆ†é…</span>**ï¼šå †å¤§å°æœ€å°128Mï¼Œè‡³å¤š8ä¸ªcpuï¼Œå› æ­¤å•ä¸ªcpuç®¡ç†çš„å†…å­˜è¶…è¿‡16Må¯èƒ½å³ä¼šå‡ºç°è·¨cpuåˆ†é…çš„æƒ…å†µã€‚å®é™…ä¸Šï¼Œè¿™æ˜¯ç®€åŒ–äº†å®ç°ã€‚